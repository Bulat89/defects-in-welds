# Обнаружение дефектов сварных швов (Welding Defect Detection)

# Инструкиця по запуску через колаб в конце

## Часть 1: Смысловое содержание проекта

Этот проект реализует полноценный MLOps-конвейер для автоматического обнаружения и локализации дефектов на радиографических снимках сварных швов.

### Цель проекта

Основная цель — разработать и внедрить стабильную, воспроизводимую систему, способную точно определять тип и местоположение дефектов (таких как трещины, пористость или непровары), что критически важно для контроля качества в промышленности.

### Модель и Архитектура

* **Задача:** Обнаружение объектов (Object Detection).
* **Архитектура:** **Faster R-CNN** (Region-based Convolutional Neural Network). Эта двухступенчатая модель сначала предлагает потенциальные области с объектами (Region Proposal Network, RPN), а затем классифицирует и уточняет каждую предложенную область (R-CNN Head). 
* **Бэкбон:** Используется предобученная сеть (вероятно, ResNet) для извлечения признаков.
* **Классы:** Модель обучена различать **N типов дефектов** плюс обязательный **класс Фон (Background)**. Общее количество выходных классов равно $N_{дефектов} + 1$.

### Стек MLOps

| Категория | Технология | Назначение |
| :--- | :--- | :--- |
| **Управление зависимостями** | **Poetry** | Управление виртуальным окружением и зависимостями (`pyproject.toml`). |
| **Фреймворк** | PyTorch Lightning | Управление циклом обучения, логированием и GPU-ускорением. |
| **Управление конфигурацией** | Hydra | Гибкое управление всеми гиперпараметрами через файл `configs/params.yaml`. |
| **Управление данными и конвейером** | DVC (Data Version Control) | Воспроизводимость результатов, версионирование данных и определение стадий конвейера (`DVC.yaml`). |
| **Логирование экспериментов** | MLflow | Отслеживание метрик, параметров и артефактов каждого запуска. |

***

## Часть 2: Технические детали и работа с проектом

### 1. Setup: Настройка окружения

Для начала разработки и воспроизведения результатов необходима корректная настройка среды с помощью **Poetry**.

#### 1.1. Установка Poetry и создание окружения

Убедитесь, что Poetry установлен в вашей системе. Затем, в корне проекта, создайте и активируйте виртуальное окружение:

    ```bash
    # 1. Установите все зависимости, указанные в pyproject.toml
    poetry install
    
    # 2. Активация окружения для работы с командами проекта
    poetry shell

### 1.2. Инициализация DVC и загрузка данных

    После настройки окружения, необходимо получить сам набор данных, который версионируется с помощью DVC.
    
    ```bash
    # Получение данных (изображений и аннотаций)
    dvc pull

***

### 2. Train: Запуск конвейера обучения

Конвейер обучения управляется через DVC, который координирует стадии подготовки данных и тренировки модели.

#### 2.1. Конфигурация гиперпараметров

Все ключевые параметры (такие как `batch_size`, `learning_rate`, `image_size`) настраиваются в файле `configs/params.yaml`.

> **Важно для GPU:** Для предотвращения `OutOfMemoryError` убедитесь, что в коде `run_training.py` для `pl.Trainer` установлена опция `precision='16-mixed'`, а `batch_size` в `params.yaml` уменьшен (рекомендуется `4` или `8`).

#### 2.2. Запуск полного цикла обучения

Для запуска полного цикла, который включает подготовку данных и тренировку модели, используйте DVC:


# Выполняет последовательно: prepare -> train, согласно DVC.yaml
dvc repro

#### 2.3. Запуск обучения с переопределением (CLI / Отладка)

Используйте Hydra для запуска, если вам нужно временно изменить параметры без редактирования `params.yaml` (например, для локальной отладки или тестирования GPU).


# Пример: Установить batch_size=4 и precision='16-mixed'
python -m defects_in_welds.training.run_training train.batch_size=4 trainer.precision=16-mixed



# код для запуска в colab

```bash
from google.colab import userdata
import os

# Установите ключи c s3 Яндекса Я могу прислать их по запросу в ТГ @CapBash
os.environ["AWS_ACCESS_KEY_ID"] = userdata.get('YANDEX_ACCESS_KEY')
os.environ["AWS_SECRET_ACCESS_KEY"] = userdata.get('YANDEX_SECRET_KEY')

# Я не смог ипортировать библиотеки в колаб через Proetry поэтому просто сделал файл requirements в колабе

requirements_content = """
# Основные зависимости (из pyproject.toml)
torch>=2.9.1,<3.0.0
pytorch-lightning>=2.6.0,<3.0.0
hydra-core>=1.3.2,<2.0.0
mlflow>=3.7.0,<4.0.0
dvc>=3.64.2,<4.0.0
fire>=0.7.1,<0.8.0
torchvision>=0.24.1,<0.25.0
albumentations>=2.0.8,<3.0.0
numpy>=2.3.5,<3.0.0
dvc-s3>=3.2.2,<4.0.0
"""

# Убедитесь, что вы находитесь в папке проекта: /content/defects-in-welds
%cd /content/defects-in-welds
with open("requirements.txt", "w") as f:
    f.write(requirements_content)

print("requirements.txt создан и готов к использованию.")


!pip install -r requirements.txt

# импорт проекта

!git clone https://github.com/Bulat89/defects-in-welds.git
%cd defects-in-welds/

# Инициализация DVC (если требуется)
!dvc pull

# Выполнение DVC-стадии 'prepare' (если она у вас была)
# Это проверит, что data_module.py работает
!python defects_in_welds/data/data_module.py prepare --img_size 640 --augmentations True


# подготовка 
!python /content/defects-in-welds/defects_in_welds/data/data_module.py prepare --img_size 640 --augmentations True
```bash

# запуск обуяения

!export PYTHONPATH=$PYTHONPATH:/content/defects-in-welds && python defects_in_welds/training/run_training.py

